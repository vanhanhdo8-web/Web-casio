#!/bin/bash

# --- Há»‡ thá»‘ng mÃ u V60 (Dual-Core Fusion) ---
R='\033[38;5;196m' G='\033[38;5;82m' Y='\033[38;5;226m' 
B='\033[38;5;33m'  P='\033[38;5;165m' C='\033[38;5;51m' 
W='\033[38;5;255m' DG='\033[38;5;236m' NC='\033[0m' 

while true; do
    clear
    TIME=$(date +"%H:%M:%S")
    MEM=$(free -m | awk '/Mem:/ {print $3"/"$2"MB"}')
    
    # Header V60 - Dual System Interface
    echo -e "${C} â•”$(printf 'â•%.0s' {1..58})â•—${NC}"
    echo -e " ${C} â•‘ ${W}DUAL-CORE V60.0 ${C}â”‚ ${P}KASIO 2K9 ${C}â”‚ ${G}RAM: $MEM ${C}â”‚ ${Y}$TIME ${C}â•‘${NC}"
    echo -e " ${C} â•š$(printf 'â•%.0s' {1..58})â•${NC}"
    
    echo -e "  ${W}ACTIVE CORES:${NC} [${P}580VNX${NC}] & [${B}880BTG${NC}]"
    echo ""

    # QuÃ©t dá»¯ liá»‡u tá»« cáº£ 2 thÆ° má»¥c
    echo -e "  ${Y}ğŸ“‚ FUSED REPOSITORY:${NC}"
    echo -e "  ${DG}â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "  ${DG}â”‚ ${W}ID   ${DG}â”‚ ${W}SOURCE FILE NAME                         ${DG}â”‚ ${W}TYPE   ${DG}â”‚${NC}"
    echo -e "  ${DG}â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
    
    filenames=()
    filepaths=()
    filetypes=()
    count=1

    # HÃ m quÃ©t thÆ° má»¥c
    scan_dir() {
        local dir=$1
        local type=$2
        local color=$3
        if [ -d "$dir" ]; then
            for file in "$dir"*; do
                if [ -f "$file" ]; then
                    local name=$(basename "$file")
                    filenames[$count]="$name"
                    filepaths[$count]="$file"
                    filetypes[$count]="$type"
                    printf "  ${DG}â”‚${NC}  ${G}%02d  ${DG}â”‚${NC}  ${W}%-40s ${DG}â”‚ ${color}%-6s ${DG}â”‚${NC}\n" "$count" "$name" "$type"
                    ((count++))
                fi
            done
        fi
    }

    # Thá»±c hiá»‡n quÃ©t
    scan_dir "./580vnx_ropchain/" "580VNX" "$P"
    scan_dir "./880btg_ropchain/" "880BTG" "$B"

    if [ $count -eq 1 ]; then
        echo -e "  ${DG}â”‚${NC}          ${R}âœ– WARNING: NO SOURCE FILES DETECTED!           ${DG}â”‚${NC}"
    fi

    echo -e "  ${DG}â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo -e "  ${W}Lá»†NH:${NC} [${G}ID${NC}] Build  [${R}0${NC}] Exit  [${W}Enter${NC}] Refresh"
    echo ""

    # Prompt V60
    echo -ne "  ${C}Kasio${W}@${C}DualCore${W}:${G}~/v60${W}$ ${NC}"
    read input

    if [[ "$input" == "0" ]]; then
        echo -e "\n  ${R}ğŸ›‘ Ngáº¯t káº¿t ná»‘i há»‡ thá»‘ng...${NC}"
        sleep 0.5; clear; exit 0
    fi

    if [[ -z "$input" ]]; then continue; fi

    # Xá»­ lÃ½ chá»n file
    if [[ "$input" =~ ^[0-9]+$ ]] && [ "$input" -ge 1 ] && [ "$input" -lt "$count" ]; then
        selected_file="${filepaths[$input]}"
        selected_name="${filenames[$input]}"
        selected_type="${filetypes[$input]}"
        
        echo -e "\n  ${G}âš¡ ÄANG BIÃŠN Dá»ŠCH:${NC} ${W}$selected_name${NC} [${Y}$selected_type${NC}]"
        
        # Hiá»‡u á»©ng náº¡p core
        echo -ne "  ${DG}Core Status: ["
        for i in {1..20}; do echo -ne "${C}#"; sleep 0.01; done
        echo -e "] ${G}READY${NC}"

        echo -e "\n  ${C}â•­$(printf 'â”€%.0s' {1..52})â•®${NC}"
        
        # LOGIC BIÃŠN Dá»ŠCH Tá»° Äá»˜NG THEO DÃ’NG MÃY
        if [[ "$selected_type" == "580VNX" ]]; then
            # DÃ¹ng compiler cho 580vnx
            python3 ./580vnx/compiler_.py -f hex < "$selected_file"
        else
            # DÃ¹ng compiler cho 880btg (Giáº£ sá»­ file compiler náº±m cÃ¹ng cáº¥u trÃºc)
            # Báº¡n cÃ³ thá»ƒ Ä‘á»•i tÃªn file python bÃªn dÆ°á»›i náº¿u compiler 880 khÃ¡c tÃªn
            python3 ./880btg/compiler_.py -f hex < "$selected_file"
        fi
        
        echo -e "  ${C}â•°$(printf 'â”€%.0s' {1..52})â•¯${NC}"
        echo -e "\n  ${G}âœ” HOÃ€N Táº¤T!${NC} Nháº¥n Enter Ä‘á»ƒ tiáº¿p tá»¥c..."
        read -n 1
    else
        echo -e "\n  ${R}âœ– Lá»—i: ID [$input] khÃ´ng tá»“n táº¡i!${NC}"
        sleep 1
    fi
done
